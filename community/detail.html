<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" id="meta-description" content="Community discussions and questions on Nexus - Ask for recommendations, share knowledge, and connect with others.">
    <meta name="keywords" content="community, discussion forum, questions, recommendations, Kampala Uganda">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Nexus Community">
    <meta property="og:title" id="og-title" content="Community Post Details">
    <meta property="og:description" id="og-description" content="Community discussions and questions on Nexus">
    <meta property="og:image" id="og-image" content="">
    <meta property="og:url" id="og-url" content="">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="Community Post Details">
    <meta name="twitter:description" id="twitter-description" content="Community discussions and questions on Nexus">
    <meta name="twitter:image" id="twitter-image" content="">
    <title id="page-title">Community Post Details</title>
    <link rel="icon" type="image/png" href="../assets/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .shimmer {
            background-color: #2d1b4e;
            background-image: linear-gradient(90deg, #2d1b4e 0%, #4a3a6e 20%, #2d1b4e 40%, #2d1b4e 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .skeleton-title {
            height: 32px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .skeleton-text {
            height: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .skeleton-badge {
            height: 20px;
            width: 80px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 12px;
        }
        
        .skeleton-image {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #000000 0%, #1a0f2e 100%);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #a855f7;
            cursor: pointer;
            margin-bottom: 24px;
            font-size: 0.95rem;
            text-decoration: none;
            transition: color 0.3s;
        }

        .back-button:hover {
            color: #c084fc;
        }

        .detail-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .post-header {
            margin-bottom: 32px;
        }

        .post-category {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
            margin-bottom: 16px;
        }

        .post-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #a855f7;
            line-height: 1.3;
        }

        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            font-size: 0.9rem;
            color: #8b5cf6;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .post-body {
            font-size: 1rem;
            line-height: 1.7;
            color: #d1d5db;
            margin-bottom: 32px;
            white-space: pre-wrap;
        }

        .post-content {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .loading {
            text-align: center;
            padding: 48px 20px;
            font-size: 1.1rem;
            color: #8b5cf6;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 24px;
        }

        /* Google Maps Style Layout */
        .maps-layout {
            display: flex;
            gap: 0;
            height: calc(100vh - 300px);
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .recommendations-sidebar {
            width: 35%;
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(168, 85, 247, 0.2);
        }

        .map-container {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        #recommendation-map {
            width: 100%;
            height: 100%;
        }

        .rec-card-item {
            padding: 20px 0;
            border-bottom: 1px solid rgba(168, 85, 247, 0.15);
            cursor: pointer;
            transition: background 0.3s;
        }

        .rec-card-item:hover {
            background: rgba(168, 85, 247, 0.05);
        }

        .rec-card-item.active {
            background: rgba(168, 85, 247, 0.1);
        }

        .rec-card-image {
            width: 160px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-left: 16px;
            flex-shrink: 0;
        }

        .rec-card-title {
            color: #a855f7;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .rec-card-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: #8b5cf6;
        }

        .rec-card-location {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #8b5cf6;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .rec-card-phone {
            color: #a855f7;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rec-card-phone:hover {
            color: #c084fc;
        }

        /* Leaflet map customization */
        .leaflet-popup-content-wrapper {
            background: #1a0f2e !important;
            border-radius: 8px;
            color: #ffffff !important;
        }

        .leaflet-popup-content {
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        .leaflet-popup-tip {
            background: #1a0f2e !important;
        }

        .no-recommendations {
            color: #8b5cf6;
            padding: 20px;
            text-align: center;
        }

        @media (max-width: 1024px) {
            .maps-layout {
                flex-direction: column;
                height: auto;
            }

            .recommendations-sidebar {
                width: 100%;
                max-height: 400px;
            }

            #recommendation-map {
                height: 400px;
            }
        }
    </style>
    <!-- JSON-LD Schema for SEO -->
    <script type="application/ld+json" id="community-schema">
    {
        "@context": "https://schema.org",
        "@type": "DiscussionForumPosting",
        "headline": "",
        "description": "",
        "image": "",
        "datePublished": "",
        "dateModified": "",
        "author": {
            "@type": "Person",
            "name": ""
        },
        "interactionStatistic": {
            "@type": "InteractionCounter",
            "interactionType": "https://schema.org/CommentAction",
            "userInteractionCount": 0
        }
    }
    </script>
</head>
<body>
    <div class="detail-container">
        <a href="javascript:history.back()" class="back-button">
            <span>‚Üê</span>
            <span>Back</span>
        </a>

        <div id="detail-content" class="loading">
            <div class="detail-header">
                <div class="skeleton-badge shimmer"></div>
                <div class="skeleton-title shimmer"></div>
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <div class="skeleton-badge shimmer"></div>
                    <div class="skeleton-badge shimmer"></div>
                    <div class="skeleton-badge shimmer"></div>
                </div>
            </div>
            <div class="skeleton-image shimmer"></div>
            <div class="section">
                <div class="skeleton-text shimmer"></div>
                <div class="skeleton-text shimmer"></div>
                <div class="skeleton-text shimmer" style="width: 80%;"></div>
            </div>
            <div style="margin-top: 32px;">
                <div class="skeleton-text shimmer" style="width: 40%; height: 24px; margin-bottom: 20px;"></div>
                <div class="skeleton-text shimmer"></div>
                <div class="skeleton-text shimmer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://tdyebwcyamsqnnivynuk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkeWVid2N5YW1zcW5uaXZ5bnVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5ODY3NzQsImV4cCI6MjA4MzM0Njc3NH0.m_3QY9xMqohJRFalwf9PFRMDDHy-_d3gLTBC_U9tcYQ';

        let supabaseClient = null;
        let mapInstance = null;
        let markersMap = {};
        
        // SEO Helper Functions
        function updateCommunityOGTags(data) {
            // Update by ID for better targeting
            const idMap = {
                'og:title': 'og-title',
                'og:description': 'og-description',
                'og:image': 'og-image',
                'og:url': 'og-url',
                'twitter:title': 'twitter-title',
                'twitter:description': 'twitter-description',
                'twitter:image': 'twitter-image'
            };
            
            const tags = [
                { property: 'og:title', content: data.title },
                { property: 'og:description', content: data.description },
                { property: 'og:image', content: data.image || '' },
                { property: 'og:url', content: window.location.href },
                { property: 'twitter:card', content: 'summary_large_image' },
                { property: 'twitter:title', content: data.title },
                { property: 'twitter:description', content: data.description },
                { property: 'twitter:image', content: data.image || '' }
            ];
            
            tags.forEach(tag => {
                // Try to find by ID first
                let element = idMap[tag.property] ? document.getElementById(idMap[tag.property]) : null;
                
                // Fall back to property search if not found by ID
                if (!element) {
                    element = document.querySelector(`meta[property="${tag.property}"]`);
                }
                
                // Create if still not found
                if (!element) {
                    element = document.createElement('meta');
                    element.setAttribute('property', tag.property);
                    element.setAttribute('id', idMap[tag.property] || '');
                    document.head.appendChild(element);
                }
                
                element.setAttribute('content', tag.content);
            });
        }
        
        function updateCommunityJSONLD(data) {
            const schema = {
                "@context": "https://schema.org",
                "@type": "DiscussionForumPosting",
                "headline": data.title,
                "description": data.description,
                "image": data.image || '',
                "datePublished": data.datePublished,
                "dateModified": data.dateModified || data.datePublished,
                "author": {
                    "@type": "Person",
                    "name": data.author
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "Nexus Community",
                    "logo": {
                        "@type": "ImageObject",
                        "url": "https://nexus.ug/logo.png"
                    }
                },
                "interactionStatistic": {
                    "@type": "InteractionCounter",
                    "interactionType": "https://schema.org/CommentAction",
                    "userInteractionCount": data.commentCount || 0
                },
                "keywords": `${data.category}, community, discussion, ${data.location}`
            };
            
            const schemaElement = document.getElementById('community-schema');
            if (schemaElement) {
                schemaElement.textContent = JSON.stringify(schema);
            }
        }

        function initSupabase() {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase initialized');
                loadPostDetail();
            } else {
                setTimeout(initSupabase, 100);
            }
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadPostDetail() {
            const postId = getQueryParam('id');
            const category = getQueryParam('category') || 'question';
            const container = document.getElementById('detail-content');

            if (!postId) {
                container.innerHTML = '<div class="error">Post ID not provided</div>';
                return;
            }

            try {
                // Load recommendations (answers) for questions
                if (category === 'question' || category === 'recommendation') {
                    await loadRecommendationDetail(postId, container);
                } else {
                    await loadPostDetail_Generic(postId, category, container);
                }
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function loadPostDetail_Generic(postId, category, container) {
            const { data, error } = await supabaseClient
                .from('community_posts')
                .select('*')
                .eq('id', postId)
                .single();

            if (error) throw error;
            if (!data) {
                container.innerHTML = '<div class="error">Post not found</div>';
                return;
            }
            
            // Update page title and SEO meta tags
            const pageTitle = `${data.title} - Nexus Community`;
            document.title = pageTitle;
            const pageTitleElement = document.getElementById('page-title');
            if (pageTitleElement) {
                pageTitleElement.textContent = pageTitle;
            }
            
            let metaDescription = document.getElementById('meta-description');
            if (!metaDescription) {
                metaDescription = document.createElement('meta');
                metaDescription.setAttribute('name', 'description');
                metaDescription.setAttribute('id', 'meta-description');
                document.head.appendChild(metaDescription);
            }
            const description = (data.body || data.title).substring(0, 155);
            metaDescription.setAttribute('content', `${data.title} - ${description}`);
            
            // Update OG tags
            updateCommunityOGTags({
                title: `${data.title} - Community Discussion`,
                description: description,
                image: data.image_url || '',
                category: category
            });
            
            // Update JSON-LD
            updateCommunityJSONLD({
                title: data.title,
                description: data.body || data.title,
                image: data.image_url,
                datePublished: data.created_at,
                dateModified: data.updated_at || data.created_at,
                author: 'Nexus Community User',
                category: category,
                location: data.location || 'Kampala, Uganda',
                commentCount: data.reply_count || 0
            });

            const html = `
                <div class="post-header">
                    <span class="post-category">${escapeHtml(category)}</span>
                    <h1 class="post-title">${escapeHtml(data.title)}</h1>
                    <div class="post-meta">
                        <div class="meta-item">
                            <span>üìÖ ${formatDate(data.created_at)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üëÅÔ∏è ${data.view_count || 0} views</span>
                        </div>
                        <div class="meta-item">
                            <span>üí¨ ${data.reply_count || 0} replies</span>
                        </div>
                    </div>
                </div>

                ${data.image_url ? `<img src="${escapeHtml(data.image_url)}" alt="${escapeHtml(data.title)}" class="post-image">` : ''}

                <div class="post-content">
                    <div class="post-body">${escapeHtml(data.body)}</div>
                </div>
            `;

            container.innerHTML = html;
        }

        async function geocodeLocation(locationName) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationName)}&format=json`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        async function initializeRecommendationsMap(recommendations) {
            if (mapInstance) {
                mapInstance.remove();
            }

            mapInstance = L.map('recommendation-map').setView([0.3476, 32.5825], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(mapInstance);

            let mapBounds = null;
            let markerCount = 0;

            for (let i = 0; i < recommendations.length; i++) {
                const rec = recommendations[i];
                if (rec.location_name) {
                    const coords = await geocodeLocation(rec.location_name);
                    if (coords) {
                        const marker = L.marker(coords)
                            .bindPopup(`
                                <div style="color: #1a0f2e;">
                                    <strong>${escapeHtml(rec.recommendation_title)}</strong><br>
                                    ${rec.location_name}<br>
                                    ${rec.contact_phone ? `${escapeHtml(rec.contact_phone)}<br>` : ''}
                                    ${rec.rating ? `‚≠ê ${rec.rating}/5.0` : ''}
                                </div>
                            `)
                            .addTo(mapInstance)
                            .on('click', function() {
                                document.getElementById(`rec-${i}`).scrollIntoView({ behavior: 'smooth' });
                                highlightRecommendation(i);
                            });

                        markersMap[i] = marker;
                        markerCount++;

                        if (!mapBounds) {
                            mapBounds = L.latLngBounds([coords], [coords]);
                        } else {
                            mapBounds.extend(coords);
                        }
                    }
                }
            }

            if (mapBounds && markerCount > 0) {
                mapInstance.fitBounds(mapBounds, { padding: [50, 50] });
            }
        }

        function highlightRecommendation(index) {
            document.querySelectorAll('.rec-card-item').forEach(el => {
                el.classList.remove('active');
            });
            const element = document.getElementById(`rec-${index}`);
            if (element) {
                element.classList.add('active');
            }
            if (markersMap[index]) {
                markersMap[index].openPopup();
            }
        }

        async function loadRecommendationDetail(postId, container) {
            const { data: post, error: postError } = await supabaseClient
                .from('community_posts')
                .select('*')
                .eq('id', postId)
                .single();

            if (postError) throw postError;

            const { data: recommendations, error: recError } = await supabaseClient
                .from('community_post_recommendations')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: false });

            if (recError) throw recError;

            let html = `
                <div class="post-header">
                    <span class="post-category">Question</span>
                    <h1 class="post-title">${escapeHtml(post.title)}</h1>
                    <div class="post-meta">
                        <div class="meta-item">
                            <span>üìÖ ${formatDate(post.created_at)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üëÅÔ∏è ${post.view_count || 0} views</span>
                        </div>
                        <div class="meta-item">
                            <span>üí¨ ${(recommendations ? recommendations.length : 0)} recommendations</span>
                        </div>
                    </div>
                </div>

                ${post.image_url ? `<img src="${escapeHtml(post.image_url)}" alt="${escapeHtml(post.title)}" class="post-image">` : ''}

                <div class="post-content">
                    <div class="post-body">${escapeHtml(post.body)}</div>
                </div>
            `;

            if (recommendations && recommendations.length > 0) {
                html += `
                    <div style="margin-top: 32px; border-top: 1px solid rgba(168, 85, 247, 0.2); padding-top: 32px;">
                        <h2 style="color: #a855f7; font-size: 1.4rem; margin-bottom: 20px;">Recommendations</h2>
                        <div class="maps-layout">
                            <div class="recommendations-sidebar">
                `;
                
                recommendations.forEach((rec, index) => {
                    html += `
                        <div id="rec-${index}" class="rec-card-item" onclick="highlightRecommendation(${index})">
                            ${rec.image_url ? `
                                <img src="${escapeHtml(rec.image_url)}" alt="${escapeHtml(rec.recommendation_title)}" class="rec-card-image">
                            ` : ''}
                            <div class="rec-card-title">${escapeHtml(rec.recommendation_title)}</div>
                            ${rec.recommendation_body ? `
                                <div style="color: #d1d5db; font-size: 0.85rem; margin-bottom: 10px; line-height: 1.5;">${escapeHtml(rec.recommendation_body)}</div>
                            ` : ''}
                            <div class="rec-card-rating">
                                ${rec.rating ? `<span>‚≠ê</span><span>${rec.rating}/5.0</span>` : '<span style="color: #666;">No rating</span>'}
                            </div>
                            ${rec.location_name ? `
                                <div class="rec-card-location">
                                    <span>üìç</span>
                                    <span>${escapeHtml(rec.location_name)}</span>
                                </div>
                            ` : ''}
                            ${rec.contact_phone ? `
                                <a href="tel:${rec.contact_phone}" class="rec-card-phone">
                                    <span>üìû</span>
                                    <span>${escapeHtml(rec.contact_phone)}</span>
                                </a>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                            <div class="map-container">
                                <div id="recommendation-map"></div>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                
                // Initialize map after content is rendered
                setTimeout(() => {
                    initializeRecommendationsMap(recommendations);
                }, 100);
            } else {
                html += '<div class="no-recommendations">No recommendations yet</div>';
                container.innerHTML = html;
            }
        }

        initSupabase();
    </script>
</body>
</html>
